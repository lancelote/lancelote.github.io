<!DOCTYPE html>
<html prefix="            og: http://ogp.me/ns# article: http://ogp.me/ns/article#     " vocab="http://ogp.me/ns" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>Диаграмма рассеяния с коробчатыми диаграммами по периметру | Pavel Karateev</title>
<link href="../../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../../../../rss.xml">
<link rel="canonical" href="http://pavelkarateev.com/posts/2014/10/19/marginal-plots/">
<!--[if lt IE 9]><script src="../../../../../assets/js/html5shiv-printshiv.min.js"></script><![endif]--><meta name="author" content="Pavel Karateev">
<link rel="next" href="../../../11/03/mosaic-plot/" title="Мозаичные диаграммы в ggplot2" type="text/html">
<meta property="og:site_name" content="Pavel Karateev">
<meta property="og:title" content="Диаграмма рассеяния с коробчатыми диаграммами по периметру">
<meta property="og:url" content="http://pavelkarateev.com/posts/2014/10/19/marginal-plots/">
<meta property="og:description" content="В последнее время при работе с R и RStudio мне с изрядной периодичностью
приходится пользоваться коробчатыми диаграммами совместно с диаграммами
рассеяния, к сожалению, в ggplot2 не существует (или я ">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2014-10-19T00:00:00+03:00">
</head>
<body>
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="container">
         
    <header id="header"><h1 id="brand"><a href="http://pavelkarateev.com/" title="Pavel Karateev" rel="home">

        <span id="blog-title">Pavel Karateev</span>
    </a></h1>

        

        
    <nav id="menu"><ul>
<li><a href="../../../../../pages/about">About</a></li>
                <li><a href="https://twitter.com/Lancel0te">Twitter</a></li>
                <li><a href="../../../../../archive.html">Archive</a></li>
                <li><a href="https://github.com/lancelote/lancelote.github.io">Source</a></li>
    
    
    </ul></nav></header><main id="content"><article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Диаграмма рассеяния с коробчатыми диаграммами по периметру</a></h1>

        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                    Pavel Karateev
            </span></p>
            <p class="dateline"><a href="." rel="bookmark"><time class="published dt-published" datetime="2014-10-19T00:00:00+03:00" itemprop="datePublished" title="2014-10-19 00:00">2014-10-19 00:00</time></a></p>
            
        <p class="sourceline"><a href="index.md" class="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<p>В последнее время при работе с R и RStudio мне с изрядной периодичностью
приходится пользоваться коробчатыми диаграммами совместно с диаграммами
рассеяния, к сожалению, в <code>ggplot2</code> не существует (или я её еще не нашел)
простой возможности удобного совместного расположения диаграмм таким образом,
чтобы учитывались границы, интервалы и поля.</p>
<p>После изучения ряда инструкций по реализации требуемого функционала, я пришел к
выводу что способ <a href="https://www.blogger.com/profile/02889896298552826810" title="Sandy Muspratt profile">Sandy Muspratt</a>, опубликованный в его <a href="http://sandymuspratt.blogspot.ru/2013/02/scatterplot-with-marginal-boxplots.html" title="Sandy Muspratt's blog post">блоге</a>,
является лучшим решением с точки зрения простоты и изящества.</p>
<p>Ниже представлен пример реализации, оригинал можно найти в блоге Сэнди.</p>
<p>Ссылки:</p>
<ul>
<li><a href="http://sandymuspratt.blogspot.ru/2013/02/scatterplot-with-marginal-boxplots.html" title="Sandy Muspratt's blog post">Sandy Muspratt's blog post</a></li>
<li><a href="http://docs.ggplot2.org/0.9.3.1/geom_boxplot.html" title="ggplot2 boxplot docs">ggplot2 boxplot docs</a></li>
</ul>
<h3>Пакеты</h3>
<p>Помимо <code>ggplot2</code> для корректного расположения диаграмм в строгом порядке
пригодятся пакеты <code>grid</code> и <code>gtable</code>.</p>
<pre class="code literal-block"><span></span><span class="kn">library</span><span class="p">(</span>ggplot2<span class="p">)</span>
</pre>


<pre class="code literal-block"><span></span>## Loading required package: methods
</pre>


<pre class="code literal-block"><span></span><span class="kn">library</span><span class="p">(</span>grid<span class="p">)</span>
<span class="kn">library</span><span class="p">(</span>gtable<span class="p">)</span>
</pre>


<h3>Данные</h3>
<p>В качестве примера возьмем предустановленный массив данных <code>mtcars</code>.</p>
<pre class="code literal-block"><span></span>data<span class="p">(</span>mtcars<span class="p">)</span>
</pre>


<h3>Диаграмма рассеяния</h3>
<p>Для начала построим диаграмму рассеяния, помимо стандартного взова <code>ggplot</code> и
<code>geom_point()</code> нам потребуется пересчитать отображаемые границы диапазона
данных. <code>ggplot2</code> делает это по умолчанию с эстетической целью - точки данных
так не будут совпадать с осями, однако нам нужно настроить границы точно для
позиционирования коробочных диаграмм.</p>
<pre class="code literal-block"><span></span>p1 <span class="o">&lt;-</span> ggplot<span class="p">(</span>mtcars<span class="p">,</span> aes<span class="p">(</span>mpg<span class="p">,</span> hp<span class="p">))</span> <span class="o">+</span>
  geom_point<span class="p">()</span> <span class="o">+</span>

  <span class="c1"># Удаляем дополнительные поля к отображаемому диапазону данных</span>
  scale_x_continuous<span class="p">(</span>expand <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">))</span> <span class="o">+</span>
  scale_y_continuous<span class="p">(</span>expand <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">))</span> <span class="o">+</span>

  <span class="c1"># Пересчитываем дополнительные поля</span>
  expand_limits<span class="p">(</span>y <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="kp">min</span><span class="p">(</span>mtcars<span class="o">$</span>hp<span class="p">)</span> <span class="o">-</span> <span class="m">0.1</span> <span class="o">*</span> <span class="kp">diff</span><span class="p">(</span><span class="kp">range</span><span class="p">(</span>mtcars<span class="o">$</span>hp<span class="p">)),</span>
    <span class="kp">max</span><span class="p">(</span>mtcars<span class="o">$</span>hp<span class="p">)</span> <span class="o">+</span> <span class="m">0.1</span> <span class="o">*</span> <span class="kp">diff</span><span class="p">(</span><span class="kp">range</span><span class="p">(</span>mtcars<span class="o">$</span>hp<span class="p">))))</span> <span class="o">+</span>
  expand_limits<span class="p">(</span>x <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="kp">min</span><span class="p">(</span>mtcars<span class="o">$</span>mpg<span class="p">)</span> <span class="o">-</span> <span class="m">0.1</span> <span class="o">*</span> <span class="kp">diff</span><span class="p">(</span><span class="kp">range</span><span class="p">(</span>mtcars<span class="o">$</span>mpg<span class="p">)),</span>
    <span class="kp">max</span><span class="p">(</span>mtcars<span class="o">$</span>mpg<span class="p">)</span> <span class="o">+</span> <span class="m">0.1</span> <span class="o">*</span> <span class="kp">diff</span><span class="p">(</span><span class="kp">range</span><span class="p">(</span>mtcars<span class="o">$</span>mpg<span class="p">))))</span> <span class="o">+</span>

  <span class="c1"># Настраиваем внешние границы</span>
  theme<span class="p">(</span>plot.margin <span class="o">=</span> unit<span class="p">(</span><span class="kt">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0.5</span><span class="p">,</span> <span class="m">0.5</span><span class="p">),</span> <span class="s">"lines"</span><span class="p">))</span>
</pre>


<h3>Коробчатые диаграммы</h3>
<p>Строим коробчатые диаграммы, при этом настраиваем внешние границы графиков и
границы отображаемого диапазона для соответствия диаграмме рассеяния.
Дополнительно удаляем оси коробчатых диаграмм - они нам не нужны.</p>
<pre class="code literal-block"><span></span><span class="c1"># Создаем тему без названий осей и меток</span>
theme_remove_all <span class="o">&lt;-</span> theme<span class="p">(</span>axis.text <span class="o">=</span> element_blank<span class="p">(),</span>
  axis.title <span class="o">=</span> element_blank<span class="p">(),</span>
  axis.ticks <span class="o">=</span> element_blank<span class="p">(),</span>
  axis.ticks.margin <span class="o">=</span> unit<span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="s">"lines"</span><span class="p">),</span>
  axis.ticks.length <span class="o">=</span> unit<span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="s">"cm"</span><span class="p">))</span>

<span class="c1"># Горизонтальная коробчатая диаграмма</span>
p2 <span class="o">&lt;-</span> ggplot<span class="p">(</span>mtcars<span class="p">,</span> aes<span class="p">(</span>x <span class="o">=</span> <span class="kp">factor</span><span class="p">(</span><span class="m">1</span><span class="p">),</span> y <span class="o">=</span> mpg<span class="p">))</span> <span class="o">+</span>
  <span class="c1"># Строим границы (whiskers) коробчатой диаграммы</span>
  stat_boxplot<span class="p">(</span>geom <span class="o">=</span><span class="s">'errorbar'</span><span class="p">)</span> <span class="o">+</span>

  <span class="c1"># Сама диаграмма</span>
  geom_boxplot<span class="p">()</span> <span class="o">+</span>

  <span class="c1"># Удаляем дополнительные поля к отображаемому диапазону данных</span>
  scale_y_continuous<span class="p">(</span>expand <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">))</span> <span class="o">+</span>

  <span class="c1"># Пересчитываем дополнительные поля</span>
  expand_limits<span class="p">(</span>y <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="kp">min</span><span class="p">(</span>mtcars<span class="o">$</span>mpg<span class="p">)</span> <span class="o">-</span> <span class="m">0.1</span> <span class="o">*</span> <span class="kp">diff</span><span class="p">(</span><span class="kp">range</span><span class="p">(</span>mtcars<span class="o">$</span>mpg<span class="p">)),</span>
                      <span class="kp">max</span><span class="p">(</span>mtcars<span class="o">$</span>mpg<span class="p">)</span> <span class="o">+</span> <span class="m">0.1</span> <span class="o">*</span> <span class="kp">diff</span><span class="p">(</span><span class="kp">range</span><span class="p">(</span>mtcars<span class="o">$</span>mpg<span class="p">))))</span> <span class="o">+</span>

  <span class="c1"># Поворачиваем диаграмму (по умолчанию коробчатые диаграммы вертикальны)</span>
  coord_flip<span class="p">()</span> <span class="o">+</span>

  <span class="c1"># Применяем тему с удаленными осями</span>
  theme_remove_all <span class="o">+</span>

  <span class="c1"># Изменяем внешние поля</span>
  theme<span class="p">(</span>plot.margin<span class="o">=</span> unit<span class="p">(</span><span class="kt">c</span><span class="p">(</span><span class="m">0.5</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0.5</span><span class="p">),</span> <span class="s">"lines"</span><span class="p">))</span>

<span class="c1"># Вертикальная коробчатая диаграмма</span>
p3 <span class="o">&lt;-</span> ggplot<span class="p">(</span>mtcars<span class="p">,</span> aes<span class="p">(</span>x <span class="o">=</span> <span class="kp">factor</span><span class="p">(</span><span class="m">1</span><span class="p">),</span> y <span class="o">=</span> hp<span class="p">))</span> <span class="o">+</span>
  <span class="c1"># Строим границы (whiskers) коробчатой диаграммы</span>
  stat_boxplot<span class="p">(</span>geom <span class="o">=</span><span class="s">'errorbar'</span><span class="p">)</span> <span class="o">+</span>

  <span class="c1"># Сама диаграмма</span>
  geom_boxplot<span class="p">()</span> <span class="o">+</span>

  <span class="c1"># Удаляем дополнительные поля к отображаемому диапазону данных</span>
  scale_y_continuous<span class="p">(</span>expand <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">))</span> <span class="o">+</span>

  <span class="c1"># Пересчитываем дополнительные поля</span>
  expand_limits<span class="p">(</span>y <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="kp">min</span><span class="p">(</span>mtcars<span class="o">$</span>hp<span class="p">)</span> <span class="o">-</span> <span class="m">0.1</span> <span class="o">*</span> <span class="kp">diff</span><span class="p">(</span><span class="kp">range</span><span class="p">(</span>mtcars<span class="o">$</span>hp<span class="p">)),</span>
                      <span class="kp">max</span><span class="p">(</span>mtcars<span class="o">$</span>hp<span class="p">)</span> <span class="o">+</span> <span class="m">0.1</span> <span class="o">*</span> <span class="kp">diff</span><span class="p">(</span><span class="kp">range</span><span class="p">(</span>mtcars<span class="o">$</span>hp<span class="p">))))</span> <span class="o">+</span>

  <span class="c1"># Применяем тему с удаленными осями</span>
  theme_remove_all <span class="o">+</span>

  <span class="c1"># Изменяем внешние поля</span>
  theme<span class="p">(</span>plot.margin<span class="o">=</span> unit<span class="p">(</span><span class="kt">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0.5</span><span class="p">,</span> <span class="m">0.5</span><span class="p">,</span> <span class="m">0</span><span class="p">),</span> <span class="s">"lines"</span><span class="p">))</span>
</pre>


<h3>gtables</h3>
<p>Создаем объекты <code>gtable</code> с диаграммами для последующей верстки.</p>
<pre class="code literal-block"><span></span>gt1 <span class="o">&lt;-</span> ggplot_gtable<span class="p">(</span>ggplot_build<span class="p">(</span>p1<span class="p">))</span> <span class="c1"># Диаграмма рассеяния</span>
gt2 <span class="o">&lt;-</span> ggplot_gtable<span class="p">(</span>ggplot_build<span class="p">(</span>p2<span class="p">))</span> <span class="c1"># Коробчатая горизонтальная диаграмма</span>
gt3 <span class="o">&lt;-</span> ggplot_gtable<span class="p">(</span>ggplot_build<span class="p">(</span>p3<span class="p">))</span> <span class="c1"># Коробчатая вертикальная диаграмма</span>
</pre>


<h3>Настройка высоты и ширины</h3>
<p>В <code>gtable</code> хранится вся информация, необходимая для построения графиков, в том
числе и поля, выделяемые для отображения меток и названий осей. Нам нужно
перезадать ширину и высоту диаграмм, чтобы верхняя коробчатая диаграмма не
"налезала" на воображаемую ось Y диаграммы рассеяния, а коробчатая диаграмма
справа не пересекала ось X.</p>
<pre class="code literal-block"><span></span><span class="c1"># Максимальная высота и ширина</span>
maxWidth <span class="o">&lt;-</span> unit.pmax<span class="p">(</span>gt1<span class="o">$</span>widths<span class="p">[</span><span class="m">2</span><span class="o">:</span><span class="m">3</span><span class="p">],</span> gt2<span class="o">$</span>widths<span class="p">[</span><span class="m">2</span><span class="o">:</span><span class="m">3</span><span class="p">])</span>
maxHeight <span class="o">&lt;-</span> unit.pmax<span class="p">(</span>gt1<span class="o">$</span>heights<span class="p">[</span><span class="m">4</span><span class="o">:</span><span class="m">5</span><span class="p">],</span> gt3<span class="o">$</span>heights<span class="p">[</span><span class="m">4</span><span class="o">:</span><span class="m">5</span><span class="p">])</span>

<span class="c1"># Задаем максимальные значения высоты и ширины в gtables для gt1, gt2 и gt3</span>
gt1<span class="o">$</span>widths<span class="p">[</span><span class="m">2</span><span class="o">:</span><span class="m">3</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="kp">as.list</span><span class="p">(</span>maxWidth<span class="p">)</span>
gt2<span class="o">$</span>widths<span class="p">[</span><span class="m">2</span><span class="o">:</span><span class="m">3</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="kp">as.list</span><span class="p">(</span>maxWidth<span class="p">)</span>

gt1<span class="o">$</span>heights<span class="p">[</span><span class="m">4</span><span class="o">:</span><span class="m">5</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="kp">as.list</span><span class="p">(</span>maxHeight<span class="p">)</span>
gt3<span class="o">$</span>heights<span class="p">[</span><span class="m">4</span><span class="o">:</span><span class="m">5</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="kp">as.list</span><span class="p">(</span>maxHeight<span class="p">)</span>
</pre>


<h3>Верстка</h3>
<pre class="code literal-block"><span></span><span class="c1"># Создаем новую пустую gtable</span>
gt <span class="o">&lt;-</span> gtable<span class="p">(</span>widths <span class="o">=</span> unit<span class="p">(</span><span class="kt">c</span><span class="p">(</span><span class="m">7</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span> <span class="s">"null"</span><span class="p">),</span> height <span class="o">=</span> unit<span class="p">(</span><span class="kt">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">7</span><span class="p">),</span> <span class="s">"null"</span><span class="p">))</span>

<span class="c1"># Вставляем gt1, gt2 и gt3 в gt</span>
gt <span class="o">&lt;-</span> gtable_add_grob<span class="p">(</span>gt<span class="p">,</span> gt1<span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
gt <span class="o">&lt;-</span> gtable_add_grob<span class="p">(</span>gt<span class="p">,</span> gt2<span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
gt <span class="o">&lt;-</span> gtable_add_grob<span class="p">(</span>gt<span class="p">,</span> gt3<span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">2</span><span class="p">)</span>

<span class="c1"># Строим рисунок</span>
grid.newpage<span class="p">()</span>
grid.draw<span class="p">(</span>gt<span class="p">)</span>
</pre>


<p><img alt="center" src="../../../../../images/2014/10/19/marginal-plots/unnamed-chunk-1-1.png"></p>
</div>
    </div>
    <aside class="postpromonav"><nav><ul class="pager hidden-print">
<li class="next">
                <a href="../../../11/03/mosaic-plot/" rel="next" title="Мозаичные диаграммы в ggplot2">Next post</a>
            </li>
        </ul></nav></aside></article></main><footer id="footer"><p>Contents © 2017         <a href="mailto:karateev.pavel@ya.ru">Pavel Karateev</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         </p>
            
        </footer>
</div>
    
    

        <script src="../../../../../assets/js/baguetteBox.min.js"></script><script>baguetteBox.run('a.reference', {
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});</script>
</body>
</html>
