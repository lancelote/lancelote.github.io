---
layout: post
title: "tidyr HOW-TO"
permalink: tidyr-how-to
---

Шпаргалка возможностей пакета `tidyr`. 

# Содержание

1. [expand](#expand)
2. [extract](#extract)
3. [extract_numeric](#extract_numeric)
4. [gather](#gather)
5. [separate](#separate)
6. [seq_range](#seq_range)
7. [spread](#spread)
8. [unite](#unite)
9. [unnest](#unnest)

# Общее

Пакет `tidyr` за авторством Hadley Wickham'а предназначен для первичной обработки сырых данных, в частности изменения их структуры. Для начала нам потребуются сам `tidyr`, а также `dplyr`:

{% highlight r %}
library(tidyr)
library(dplyr)
{% endhighlight %}

# expand() <a name="expand"></a>

## Назначение

Создает `data.frame` включающий все комбинации заданных переменных без перестановок

## Использование

`expand(data, ...)`

## Аргументы

- `data` - оригинальный `data.frame`
- `...` - имена переменных для комбинации (допустимы выражения вместо непосредственно имен)

## Примеры использования

Данные:

{% highlight r %}
df <- data.frame(a = c(1, 2, 5), b = c(3, 5, 3), c = c(1, 2, 3))
df
{% endhighlight %}



{% highlight text %}
##   a b c
## 1 1 3 1
## 2 2 5 2
## 3 5 3 3
{% endhighlight %}

Все комбинации переменных `vs` и `cyl`:

{% highlight r %}
expand(mtcars, vs, cyl)
{% endhighlight %}



{% highlight text %}
##   vs cyl
## 1  0   4
## 2  0   6
## 3  0   8
## 4  1   4
## 5  1   6
## 6  1   8
{% endhighlight %}

Все комбинации переменных `cyl` и `mpg`, последняя при этом принимает только минимальное или максимальное значение:

{% highlight r %}
expand(mtcars, cyl, mpg = seq_range(mpg, 2))
{% endhighlight %}



{% highlight text %}
##   cyl  mpg
## 1   4 10.4
## 2   4 33.9
## 3   6 10.4
## 4   6 33.9
## 5   8 10.4
## 6   8 33.9
{% endhighlight %}

Все комбинации переменных `cyl` и `mpg`, последняя при этом принимает значения из разбитого на 5 равных частей диапазона:

{% highlight r %}
expand(mtcars, cyl, mpg = seq_range(mpg, 5))
{% endhighlight %}



{% highlight text %}
##    cyl    mpg
## 1    4 10.400
## 2    4 16.275
## 3    4 22.150
## 4    4 28.025
## 5    4 33.900
## 6    6 10.400
## 7    6 16.275
## 8    6 22.150
## 9    6 28.025
## 10   6 33.900
## 11   8 10.400
## 12   8 16.275
## 13   8 22.150
## 14   8 28.025
## 15   8 33.900
{% endhighlight %}

Все комбинации переменных `a`, `b` и `c`:

{% highlight r %}
expand(df)
{% endhighlight %}



{% highlight text %}
##    a b c
## 1  1 3 1
## 2  1 3 2
## 3  1 3 3
## 4  1 5 1
## 5  1 5 2
## 6  1 5 3
## 7  2 3 1
## 8  2 3 2
## 9  2 3 3
## 10 2 5 1
## 11 2 5 2
## 12 2 5 3
## 13 5 3 1
## 14 5 3 2
## 15 5 3 3
## 16 5 5 1
## 17 5 5 2
## 18 5 5 3
{% endhighlight %}

Все комбинации переменных `a` и `b`:

{% highlight r %}
expand(df, a, b)
{% endhighlight %}



{% highlight text %}
##   a b
## 1 1 3
## 2 1 5
## 3 2 3
## 4 2 5
## 5 5 3
## 6 5 5
{% endhighlight %}

Все комбинации переменных `a` и `c`:

{% highlight r %}
expand(df, a, c)
{% endhighlight %}



{% highlight text %}
##   a c
## 1 1 1
## 2 1 2
## 3 1 3
## 4 2 1
## 5 2 2
## 6 2 3
## 7 5 1
## 8 5 2
## 9 5 3
{% endhighlight %}

Все комбинации переменных `b ` и `c`:

{% highlight r %}
expand(df, b, c)
{% endhighlight %}



{% highlight text %}
##   b c
## 1 3 1
## 2 3 2
## 3 3 3
## 4 5 1
## 5 5 2
## 6 5 3
{% endhighlight %}

# extract() <a name="extract"></a>

## Назначение

Применяет регулярное выражение к переменной и создает одну или несколько новых на основе результата

## Использование

```
extract(data, col, into, regex = "([[:alnum:]]+)", remove = TRUE,
        convert = FALSE, ...)
```

## Аргументы

- `data` - оригинальный `data.frame`
- `col` - имя переменной
- `into` - имена новых переменных
- `regex` - регулярное выражение для поиска требуемых данных
- `remove` - если `TRUE` - удаляет `col` из результирующего `data.frame`
- `convert` - если `TRUE` - применяет `type.convert` c `as.is = TRUE` к новым переменным
- `...` - дополнительные аргументы для `regexec`

## Примеры использования

Данные:

{% highlight r %}
df <- data.frame(x = c("a.b", "a.d", "b.c"))
df
{% endhighlight %}



{% highlight text %}
##     x
## 1 a.b
## 2 a.d
## 3 b.c
{% endhighlight %}

Извлечь из переменной `x` первую букву:

{% highlight r %}
df %>% extract(x, "A")
{% endhighlight %}



{% highlight text %}
##   A
## 1 a
## 2 a
## 3 b
{% endhighlight %}

Разбить переменную `x`:

{% highlight r %}
df %>% extract(x, c("A", "B"), "([[:alnum:]]+)\\.([[:alnum:]]+)")
{% endhighlight %}



{% highlight text %}
##   A B
## 1 a b
## 2 a d
## 3 b c
{% endhighlight %}

# extract_numeric() <a name="extract_numeric"></a>

## Назначение

Используя регулярное выражения удаляет все нецифровые знаки из строки и трансформирует результат в число

## Использование

```
extract_numeric
```

## Аргументы

- `x` - `character vector` или `factor`

## Примеры использования


{% highlight r %}
extract_numeric("$1,200.34")
{% endhighlight %}



{% highlight text %}
## [1] 1200.34
{% endhighlight %}


{% highlight r %}
extract_numeric("-2%")
{% endhighlight %}



{% highlight text %}
## [1] -2
{% endhighlight %}

Может некорректно работать со строками, которые точно не являются цифровыми данными:

{% highlight r %}
extract_numeric("-2-2")
{% endhighlight %}



{% highlight text %}
## Warning in extract_numeric("-2-2"): NAs introduced by coercion
{% endhighlight %}



{% highlight text %}
## [1] NA
{% endhighlight %}



{% highlight r %}
extract_numeric("12abc34")
{% endhighlight %}



{% highlight text %}
## [1] 1234
{% endhighlight %}

# gather() <a name="gather"></a>

## Назначение

Объединяет переменные, имена переменных для объединения становятся уровнями переменной `key`, значения объединенных переменных заполняют соответственно переменную `value`

## Использование

```
gather(data, key, value, ..., na.rm = FALSE, convert = FALSE)
```

## Аргументы

- `data` - оригинальный `data.frame`
- `key`, `value` - `key`, `value` переменные
- `...` - переменные для объединения, выбор нескольких: `x:z`, исключить: `-y`
- `na.rm` - если `TRUE` - удалить все `NA`
- `convert` - если `TRUE` - применяет `type.convert` к `key` переменной

## Примеры использования

Данные:

{% highlight r %}
stocks <- data.frame(
time = as.Date('2009-01-01') + 0:9,
X = rnorm(10, 0, 1),
Y = rnorm(10, 0, 2),
Z = rnorm(10, 0, 4)
)
stocks
{% endhighlight %}



{% highlight text %}
##          time          X          Y          Z
## 1  2009-01-01 -0.6942977 -3.1169295  5.0240035
## 2  2009-01-02 -0.3479669  1.2335776 -5.1658450
## 3  2009-01-03 -0.9553359  2.3672506 -7.9637198
## 4  2009-01-04 -0.2007025  1.5679249  0.7408330
## 5  2009-01-05 -0.8969155 -0.2372433  4.9205768
## 6  2009-01-06  0.6038219 -2.2633887 -5.2681170
## 7  2009-01-07  0.2187883 -0.5116599 -0.4756659
## 8  2009-01-08  1.3154993 -0.8551766  4.4662914
## 9  2009-01-09 -1.6138473 -2.4725982 -4.6206638
## 10 2009-01-10 -0.2140121  3.1647792 -8.6969779
{% endhighlight %}

Объединить имена переменных `X`, `Y`, `Z` в качестве уровней новой переменной `stock`, значения объединенных переменных заполнят переменную `price`:

{% highlight r %}
stocks %>% gather(stock, price, -time)
{% endhighlight %}



{% highlight text %}
##          time stock      price
## 1  2009-01-01     X -0.6942977
## 2  2009-01-02     X -0.3479669
## 3  2009-01-03     X -0.9553359
## 4  2009-01-04     X -0.2007025
## 5  2009-01-05     X -0.8969155
## 6  2009-01-06     X  0.6038219
## 7  2009-01-07     X  0.2187883
## 8  2009-01-08     X  1.3154993
## 9  2009-01-09     X -1.6138473
## 10 2009-01-10     X -0.2140121
## 11 2009-01-01     Y -3.1169295
## 12 2009-01-02     Y  1.2335776
## 13 2009-01-03     Y  2.3672506
## 14 2009-01-04     Y  1.5679249
## 15 2009-01-05     Y -0.2372433
## 16 2009-01-06     Y -2.2633887
## 17 2009-01-07     Y -0.5116599
## 18 2009-01-08     Y -0.8551766
## 19 2009-01-09     Y -2.4725982
## 20 2009-01-10     Y  3.1647792
## 21 2009-01-01     Z  5.0240035
## 22 2009-01-02     Z -5.1658450
## 23 2009-01-03     Z -7.9637198
## 24 2009-01-04     Z  0.7408330
## 25 2009-01-05     Z  4.9205768
## 26 2009-01-06     Z -5.2681170
## 27 2009-01-07     Z -0.4756659
## 28 2009-01-08     Z  4.4662914
## 29 2009-01-09     Z -4.6206638
## 30 2009-01-10     Z -8.6969779
{% endhighlight %}

# separate() <a name="separate"></a>

## Назначение

Разбивает переменную на несколько

## Использование

```
separate(data, col, into, sep = "[^[:alnum:]]+", remove = TRUE,
         convert = FALSE, extra = "error", ...)
```

## Аргументы

- `data` - оригинальный `data.frame`
- `col` - имя переменной для разбивки
- `into` - имена новых переменных
- `sep` - разделитель, если `character` - воспринимается как регулярное выражение, по-умолчанию - последовательность не цифро-буквенных знаков, если `numeric` - воспринимается как позиция для разделения
- `remove` - если `TRUE` - удаляет `col` из результирующего `data.frame`
- `convert` - если `TRUE` - применяет `type.convert` c `as.is = TRUE` к новым переменным
- `extra` - если `sep` - `character`, то аргумент задает реакцию на превышение допустимого числа новых переменных (`into`):
    - `error` - ошибка по-умолчанию
    - `drop` - возвращает `length(into)`, отбрасывает все сверху или расширяет `data.frame`
    - `merge` - разделяет только `length(into)` раз
- `...` - дополнительные переменные для `strsplit`

## Примеры использования

Данные:

{% highlight r %}
df <- data.frame(x = c("a.b", "a.d", "b.c"))
df
{% endhighlight %}



{% highlight text %}
##     x
## 1 a.b
## 2 a.d
## 3 b.c
{% endhighlight %}

Разбить переменную `x` на две, разделитель - `.`:

{% highlight r %}
df %>% separate(x, c("A", "B"))
{% endhighlight %}



{% highlight text %}
##   A B
## 1 a b
## 2 a d
## 3 b c
{% endhighlight %}

Если строки нельзя разделить на равное число переменных:

{% highlight r %}
df <- data.frame(x = c("a", "a b", "a b c"))
df %>% separate(x, c("a", "b"), extra = "merge")
{% endhighlight %}



{% highlight text %}
##   a    b
## 1 a <NA>
## 2 a    b
## 3 a  b c
{% endhighlight %}



{% highlight r %}
df %>% separate(x, c("a", "b"), extra = "drop")
{% endhighlight %}



{% highlight text %}
##   a    b
## 1 a <NA>
## 2 a    b
## 3 a    b
{% endhighlight %}

Данные:

{% highlight r %}
df <- data.frame(x = c("x: 123", "y: error: 7"))
df
{% endhighlight %}



{% highlight text %}
##             x
## 1      x: 123
## 2 y: error: 7
{% endhighlight %}

Разбить строки строго на две переменные по первому включению `sep`:

{% highlight r %}
df %>% separate(x, c("key", "value"), ": ", extra = "merge")
{% endhighlight %}



{% highlight text %}
##   key    value
## 1   x      123
## 2   y error: 7
{% endhighlight %}

# seq_range() <a name="seq_range"></a>

## Назначение

Возвращает вектор из `n` значений от минимального до максимального `x` с равными промежутками

## Использование

```
seq_range(x, n)
```

## Аргументы

- `x` - `numeric vector`
- `n` - число значений

## Примеры использования

Разобьем диапазон значений вектора `1:100`: 

{% highlight r %}
seq_range(1:100, 5)
{% endhighlight %}



{% highlight text %}
## [1]   1.00  25.75  50.50  75.25 100.00
{% endhighlight %}

# spread() <a name="spread"></a>

## Назначение

Переформатирует `data.frame` - используя в качестве новых переменных уровни заданной переменной `key`, заполняя таблицу соответствующими значениями переменной `value`.

## Использование

```
spread(data, key, value, fill = NA, convert = FALSE, drop = TRUE)
```

## Аргументы

- `data` - `numeric vector`
- `key` - переменная, чьи уровни станут новыми переменными
- `value` - переменная, соответствующими значениями которой будут заполнены новые столбцы
- `fill` - если для комбинации переменной `key` и других переменных нет значения - подставляет на его место указанное 
- `convert` - если `TRUE` - применяет `type.convert` c `as.is = TRUE` к новым переменным
- `drop` - если `FALSE` - сохранить уровни факторов, для которых нет значений в данных, заполняя их по правилу `fill`

## Примеры использования

Данные:

{% highlight r %}
stocks <- data.frame(
time = as.Date('2009-01-01') + 0:9,
X = rnorm(10, 0, 1),
Y = rnorm(10, 0, 2),
Z = rnorm(10, 0, 4)
)
stocks
{% endhighlight %}



{% highlight text %}
##          time          X           Y         Z
## 1  2009-01-01 -0.3428077 -0.35440272 -2.404979
## 2  2009-01-02 -0.3335383 -1.51181729  2.400513
## 3  2009-01-03 -1.0899850 -0.80553673 -6.556129
## 4  2009-01-04  1.7298972 -3.16015063 -3.615143
## 5  2009-01-05  0.3186909 -0.07844152 -4.447004
## 6  2009-01-06 -0.5890254  1.78480693 -1.922107
## 7  2009-01-07  0.8885608  0.96222058  3.591545
## 8  2009-01-08  1.3944331 -1.10526936 -3.595118
## 9  2009-01-09 -1.6939384 -1.30637395  3.291640
## 10 2009-01-10  0.9070373 -3.84822729 -1.181220
{% endhighlight %}

Противоположность `gather`:

{% highlight r %}
stocksm <- stocks %>% gather(stock, price, -time)
head(stocksm)
{% endhighlight %}



{% highlight text %}
##         time stock      price
## 1 2009-01-01     X -0.3428077
## 2 2009-01-02     X -0.3335383
## 3 2009-01-03     X -1.0899850
## 4 2009-01-04     X  1.7298972
## 5 2009-01-05     X  0.3186909
## 6 2009-01-06     X -0.5890254
{% endhighlight %}



{% highlight r %}
stocksm %>% spread(stock, price)
{% endhighlight %}



{% highlight text %}
##          time          X           Y         Z
## 1  2009-01-01 -0.3428077 -0.35440272 -2.404979
## 2  2009-01-02 -0.3335383 -1.51181729  2.400513
## 3  2009-01-03 -1.0899850 -0.80553673 -6.556129
## 4  2009-01-04  1.7298972 -3.16015063 -3.615143
## 5  2009-01-05  0.3186909 -0.07844152 -4.447004
## 6  2009-01-06 -0.5890254  1.78480693 -1.922107
## 7  2009-01-07  0.8885608  0.96222058  3.591545
## 8  2009-01-08  1.3944331 -1.10526936 -3.595118
## 9  2009-01-09 -1.6939384 -1.30637395  3.291640
## 10 2009-01-10  0.9070373 -3.84822729 -1.181220
{% endhighlight %}

Разбить `price` по переменной `time`:

{% highlight r %}
stocksm %>% spread(time, price)
{% endhighlight %}



{% highlight text %}
##   stock 2009-01-01 2009-01-02 2009-01-03 2009-01-04  2009-01-05 2009-01-06
## 1     X -0.3428077 -0.3335383 -1.0899850   1.729897  0.31869092 -0.5890254
## 2     Y -0.3544027 -1.5118173 -0.8055367  -3.160151 -0.07844152  1.7848069
## 3     Z -2.4049789  2.4005132 -6.5561293  -3.615143 -4.44700386 -1.9221066
##   2009-01-07 2009-01-08 2009-01-09 2009-01-10
## 1  0.8885608   1.394433  -1.693938  0.9070373
## 2  0.9622206  -1.105269  -1.306374 -3.8482273
## 3  3.5915454  -3.595118   3.291640 -1.1812203
{% endhighlight %}

# unite() <a name="unite"></a>

## Назначение

Объединяет переменные в одну

## Использование

```
unite(data, col, ..., sep = "_", remove = TRUE)
```

## Аргументы

- `data` - `numeric vector`
- `col` - имя базовой переменной
- `...` - переменные для объединения с базовой
- `sep` - разделитель между значениями объединенных переменных 
- `remove` - если `TRUE` - удаляет переменные для объединения

## Примеры использования

Объединяем переменные `vs` и `am` в одну:

{% highlight r %}
mtcars %>%
  unite_("vs_am", c("vs", "am")) %>%
  head()
{% endhighlight %}



{% highlight text %}
##                    mpg cyl disp  hp drat    wt  qsec vs_am gear carb
## Mazda RX4         21.0   6  160 110 3.90 2.620 16.46   0_1    4    4
## Mazda RX4 Wag     21.0   6  160 110 3.90 2.875 17.02   0_1    4    4
## Datsun 710        22.8   4  108  93 3.85 2.320 18.61   1_1    4    1
## Hornet 4 Drive    21.4   6  258 110 3.08 3.215 19.44   1_0    3    1
## Hornet Sportabout 18.7   8  360 175 3.15 3.440 17.02   0_0    3    2
## Valiant           18.1   6  225 105 2.76 3.460 20.22   1_0    3    1
{% endhighlight %}

Противоположность `separate`:

{% highlight r %}
mtcars %>%
  unite(vs_am, vs, am) %>%
  separate(vs_am, c("vs", "am")) %>%
  head()
{% endhighlight %}



{% highlight text %}
##                    mpg cyl disp  hp drat    wt  qsec vs am gear carb
## Mazda RX4         21.0   6  160 110 3.90 2.620 16.46  0  1    4    4
## Mazda RX4 Wag     21.0   6  160 110 3.90 2.875 17.02  0  1    4    4
## Datsun 710        22.8   4  108  93 3.85 2.320 18.61  1  1    4    1
## Hornet 4 Drive    21.4   6  258 110 3.08 3.215 19.44  1  0    3    1
## Hornet Sportabout 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2
## Valiant           18.1   6  225 105 2.76 3.460 20.22  1  0    3    1
{% endhighlight %}

# unnest() <a name="unnest"></a>

## Назначение

Разбивает переменную на большее число строк за счет раскрытия вложенных элементов

## Использование

```
unnest(data, col = NULL)
```

## Аргументы

- `data` - оригинальный `data.frame`
- `col` - переменная, которую нужно разбить на большее число строк

## Примеры использования

Данные:

{% highlight r %}
df <- data.frame(
x = 1:3,
y = c("a", "d,e,f", "g,h"),
stringsAsFactors = FALSE
)
df
{% endhighlight %}



{% highlight text %}
##   x     y
## 1 1     a
## 2 2 d,e,f
## 3 3   g,h
{% endhighlight %}

Разбить переменную `y` на большее число строк:

{% highlight r %}
df %>%
  transform(y = strsplit(y, ",")) %>%
  unnest(y)
{% endhighlight %}



{% highlight text %}
##   x y
## 1 1 a
## 2 2 d
## 3 2 e
## 4 2 f
## 5 3 g
## 6 3 h
{% endhighlight %}

Разобьем стандартный набор данных `iris` по виду цветка:

{% highlight r %}
my_list <- lapply(split(subset(iris, select = -Species), iris$Species), "[", 1:2, )
my_list
{% endhighlight %}



{% highlight text %}
## $setosa
##   Sepal.Length Sepal.Width Petal.Length Petal.Width
## 1          5.1         3.5          1.4         0.2
## 2          4.9         3.0          1.4         0.2
## 
## $versicolor
##    Sepal.Length Sepal.Width Petal.Length Petal.Width
## 51          7.0         3.2          4.7         1.4
## 52          6.4         3.2          4.5         1.5
## 
## $virginica
##     Sepal.Length Sepal.Width Petal.Length Petal.Width
## 101          6.3         3.3          6.0         2.5
## 102          5.8         2.7          5.1         1.9
{% endhighlight %}

Соберем список обратно в `data.frame`:

{% highlight r %}
unnest(my_list)
{% endhighlight %}



{% highlight text %}
## Source: local data frame [6 x 4]
## 
##   Sepal.Length Sepal.Width Petal.Length Petal.Width
## 1          5.1         3.5          1.4         0.2
## 2          4.9         3.0          1.4         0.2
## 3          7.0         3.2          4.7         1.4
## 4          6.4         3.2          4.5         1.5
## 5          6.3         3.3          6.0         2.5
## 6          5.8         2.7          5.1         1.9
{% endhighlight %}

Добавим потерявшуюся переменную `Species`:

{% highlight r %}
unnest(my_list, Species)
{% endhighlight %}



{% highlight text %}
##      Species Sepal.Length Sepal.Width Petal.Length Petal.Width
## 1     setosa          5.1         3.5          1.4         0.2
## 2     setosa          4.9         3.0          1.4         0.2
## 3 versicolor          7.0         3.2          4.7         1.4
## 4 versicolor          6.4         3.2          4.5         1.5
## 5  virginica          6.3         3.3          6.0         2.5
## 6  virginica          5.8         2.7          5.1         1.9
{% endhighlight %}
